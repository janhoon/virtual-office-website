[
  {
    "category": "Feature - PostHog Integration (Website)",
    "description": "Integrate PostHog analytics into Speke Astro landing page for marketing analytics, conversion tracking, and A/B testing.",
    "fizzyCard": 253,
    "steps": [
      "PHASE 1: Install PostHog SDK",
      "Install posthog-js: npm install posthog-js",
      "",
      "PHASE 2: Add PostHog Script to Layout",
      "Update src/layouts/Layout.astro",
      "Add PostHog initialization script in <head>:",
      "- Host: https://eu.i.posthog.com",
      "- API Key: phc_SufADq1sXKA8eN4wSAMaAmIPwWVP3GR9mcPaE8xcJLW",
      "- Load posthog-js from CDN or bundle",
      "Initialize PostHog globally (window.posthog)",
      "",
      "PHASE 3: Track Page Views",
      "PostHog auto-captures page views by default",
      "Verify page view events appear in PostHog dashboard",
      "Add page metadata if needed (title, path, referrer)",
      "",
      "PHASE 4: Track Waitlist Form Submissions",
      "Update src/components/Waitlist.astro or form component",
      "Track custom event on form submit:",
      "- Event: waitlist_signup",
      "- Properties: { email, source: landing_page }",
      "Track successful vs failed submissions separately",
      "",
      "PHASE 5: Track CTA Button Clicks",
      "Add tracking to primary CTA buttons:",
      "- Hero CTA (\"Get Started\", \"Join Waitlist\")",
      "- Feature section CTAs",
      "- Footer CTAs",
      "Event name: cta_clicked",
      "Properties: { cta_text, cta_location, cta_url }",
      "",
      "PHASE 6: Conversion Funnels",
      "Define conversion funnel in PostHog:",
      "1. Page view (landing)",
      "2. CTA clicked",
      "3. Waitlist form viewed",
      "4. Waitlist signup completed",
      "Set up funnel in PostHog dashboard (not in code)",
      "",
      "PHASE 7: A/B Testing Setup (Optional)",
      "Add feature flag support for A/B tests",
      "Example: test different hero copy or CTA text",
      "Use posthog.isFeatureEnabled(variant_a) in Astro components",
      "Track which variant user sees",
      "",
      "PHASE 8: Environment Configuration",
      "Add PUBLIC_POSTHOG_API_KEY to .env",
      "Add PUBLIC_POSTHOG_HOST to .env (https://eu.i.posthog.com)",
      "Disable PostHog in development mode (optional)",
      "Update wrangler.toml with env vars for Cloudflare Pages deployment",
      "Document env vars in README or DEPLOYMENT.md",
      "",
      "PHASE 9: Test PostHog Integration",
      "TEST: PostHog initializes on page load",
      "TEST: Page views tracked",
      "TEST: Waitlist form submission tracked",
      "TEST: CTA button clicks tracked",
      "TEST: Events visible in PostHog dashboard",
      "TEST: No PostHog errors in browser console",
      "TEST: Works on Cloudflare Pages deployment (prod)",
      "",
      "PHASE 10: Update PRD and Commit",
      "Set passes: true in prd.json",
      "Update progress.txt",
      "Commit: \"feat: integrate PostHog analytics in landing page (#253)\""
    ],
    "passes": true
  },
  {
    "category": "Waitlist Form - Cloudflare Turnstile CAPTCHA protection",
    "description": "Add Cloudflare Turnstile (free, invisible CAPTCHA) to the waitlist form to block bot submissions. Verify token server-side in the Cloudflare Worker before writing to D1 database.",
    "fizzyCard": 275,
    "passes": true,
    "steps": [
      "PHASE 1: Add Turnstile widget to Waitlist.astro",
      "Add Turnstile script tag to Layout.astro or Waitlist.astro: <script src='https://challenges.cloudflare.com/turnstile/v0/api.js' async defer></script>",
      "Add widget div inside the form: <div class='cf-turnstile' data-sitekey={import.meta.env.PUBLIC_TURNSTILE_SITE_KEY}></div>",
      "For local dev: use test site key '1x00000000000000000000AA' (always passes) as default",
      "Ensure Turnstile token is included in form submit POST body as 'cf-turnstile-response'",
      "Read token from window.turnstile.getResponse() or from the cf-turnstile-response hidden input",
      "",
      "PHASE 2: Update Worker (worker/src/index.ts) to verify Turnstile token",
      "Add TURNSTILE_SECRET_KEY to Worker env interface (Env type)",
      "In the waitlist POST handler, after parsing body:",
      "  Extract token = body['cf-turnstile-response']",
      "  If no token: return 400 {error: 'Missing CAPTCHA token'}",
      "  Call: POST https://challenges.cloudflare.com/turnstile/v0/siteverify",
      "    Body: {secret: env.TURNSTILE_SECRET_KEY, response: token, remoteip: request.headers.get('CF-Connecting-IP')}",
      "  If !verifyData.success: return 400 {error: 'CAPTCHA verification failed'}",
      "  Only proceed to D1 insert if verification passes",
      "For local dev without secret key: use test secret '1x0000000000000000000000000000000AA'",
      "",
      "PHASE 3: Environment variables",
      "Add to .env: PUBLIC_TURNSTILE_SITE_KEY=1x00000000000000000000AA (test key for local)",
      "Add to worker/.env or wrangler.toml [vars]: TURNSTILE_SECRET_KEY=1x0000000000000000000000000000000AA (test key for local)",
      "Document in README: production keys must be added in Cloudflare dashboard (Pages env vars + Worker secrets)",
      "Do NOT commit production keys",
      "",
      "PHASE 4: Test locally",
      "pnpm dev to start Astro dev server",
      "cd worker && wrangler dev to run Worker locally",
      "TEST: Submit form → token sent to worker → worker verifies → email saved",
      "TEST: Submit without token → 400 returned",
      "TEST: Turnstile widget renders (even in test mode it may show briefly)",
      "",
      "PHASE 5: Update PRD and commit",
      "Set passes: true in prd.json",
      "Update progress.txt",
      "Commit: 'feat: add Cloudflare Turnstile CAPTCHA to waitlist form (#275)'",
      "",
      "PHASE 6: Deployment instructions (document, do not auto-deploy)",
      "Jan must:",
      "  1. Go to Cloudflare Dashboard → Turnstile → Add site → getspeke.com → note Site Key + Secret Key",
      "  2. Add PUBLIC_TURNSTILE_SITE_KEY to Cloudflare Pages env vars (project virtual-office-website)",
      "  3. Add TURNSTILE_SECRET_KEY as Worker Secret: wrangler secret put TURNSTILE_SECRET_KEY",
      "  4. Rebuild and redeploy Pages: PUBLIC_TURNSTILE_SITE_KEY=<real-key> pnpm build && wrangler pages deploy dist --project-name virtual-office-website --branch=master",
      "  5. Redeploy worker: cd worker && wrangler deploy"
    ]
  }
]
